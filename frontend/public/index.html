<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Voting Pilkades 2026 | Pemilihan Kepala Desa</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap 5.3 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- HTML5 QR Code Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Keccak256 library (untuk hash NIK di frontend) -->
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/keccak.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #0b5ed7;
      --success: #198754;
      --danger: #dc3545;
      --light-bg: #f8f9fa;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e9fd 100%);
      min-height: 100vh;
      padding-bottom: 3rem;
      margin: 0;
    }

    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(90deg, #0d6efd, #0b5ed7);
      color: white;
      border-radius: 16px 16px 0 0;
      padding: 1.5rem;
    }

    .btn-primary {
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      border-radius: 10px;
    }

    .form-control-lg {
      border-radius: 10px;
      padding: 0.75rem 1.25rem;
    }

    .alert-fixed {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1050;
      max-width: 90%;
      width: 480px;
    }

    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Halaman Scan QR Full Screen */
    #scanPage {
      position: fixed;
      inset: 0;
      background: #000;
      color: white;
      z-index: 1000;
      display: none;
      padding: 1.5rem;
      overflow-y: auto;
    }

    #reader {
      width: 100%;
      max-width: 420px;
      margin: 0 auto 2rem;
      border-radius: 12px;
      overflow: hidden;
      background: #111;
    }

    /* Warna Default (Light Mode) */
    :root {
      --primary-bg: linear-gradient(135deg, #f5f7fa 0%, #e4e9fd 100%);
      --card-bg: #ffffff;
      --text-main: #212529;
      --text-muted: #6c757d;
      --border-color: #dee2e6;
      --list-item-bg: #ffffff;
      /* Tambahan */
      --list-item-hover: #f8f9fa;
      /* Tambahan */
    }

    /* Warna untuk Dark Mode */
    [data-theme="dark"] {
      --primary-bg: linear-gradient(135deg, #121212 0%, #1a1a2e 100%);
      --card-bg: #1e1e1e;
      --text-main: #f8f9fa;
      --text-muted: #adb5bd;
      --border-color: #383838;
      --list-item-bg: #2b2b2b;
      /* Tambahan */
      --list-item-hover: #333333;
      /* Tambahan */
    }

    /* Terapkan pada List Group Item (Daftar Kandidat) */
    .list-group-item {
      background-color: var(--list-item-bg) !important;
      color: var(--text-main) !important;
      border-color: var(--border-color) !important;
    }

    .list-group-item-action:hover {
      background-color: var(--list-item-hover) !important;
    }

    /* Perbaikan untuk Container Visi & Misi di Modal agar mengikuti tema */
    .bg-light {
      background-color: var(--list-item-bg) !important;
      color: var(--text-main) !important;
    }

    body {
      background: var(--primary-bg) !important;
      color: var(--text-main);
    }

    .card {
      background-color: var(--card-bg) !important;
      color: var(--text-main);
      border: 1px solid var(--border-color);
    }

    .text-muted {
      color: var(--text-muted) !important;
    }

    /* Pastikan Modal Body juga berubah */
    .modal-content {
      background-color: var(--card-bg) !important;
      color: var(--text-main) !important;
    }

    /* Header Modal agar tidak kaku */
    #modalHeaderColor {
      height: 100px;
      transition: 0.3s;
      /* Memberikan efek gradasi agar warna solid dari JSON lebih berdimensi */
      background-image: linear-gradient(to bottom right, rgba(255, 255, 255, 0.2), rgba(0, 0, 0, 0.1));
    }

    /* Container Visi & Misi dengan warna latar yang sangat lembut */
    #visiContainer,
    #misiContainer {
      border-left-width: 4px !important;
      /* Menggunakan background transparan agar mengikuti warna tema (Dark/Light) */
      background-color: rgba(128, 128, 128, 0.05) !important;
      border-radius: 12px;
    }

    /* Khusus Dark Mode: Kita turunkan saturasi warna agar tidak menusuk */
    [data-theme="dark"] #modalHeaderColor {
      filter: saturate(0.7) brightness(0.9);
    }

    .assistive-touch {
      position: fixed;
      bottom: 100px;
      /* Posisi awal */
      right: 20px;
      width: 55px;
      height: 55px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      /* Efek kaca Apple */
      -webkit-backdrop-filter: blur(10px);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #333;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      cursor: grab;
      z-index: 2000;
      touch-action: none;
      /* Penting untuk drag di mobile */
      user-select: none;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: transform 0.2s, background 0.3s, opacity 0.3s, left 0.3s ease;
    }

    [data-theme="dark"] .assistive-touch {
      background: rgba(40, 40, 40, 0.7);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .assistive-touch:active {
      cursor: grabbing;
      transform: scale(0.9);
    }

    /* Transisi warna global agar halus */
    body,
    .card,
    .list-group-item,
    #theme-touch {
      transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease;
    }

    /* Pastikan container ikon punya transisi */
    #theme-icon {
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
    }

    /* Efek saat ikon berubah (kelas ini akan dipicu via JS) */
    .icon-rotate {
      transform: rotate(360deg) scale(0);
      opacity: 0;
    }

    .loaded body,
    .loaded .card,
    .loaded .list-group-item {
      transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease !important;
    }

    /* Timer Mewah & Modern */
    #countdownTimer {
      font-family: 'JetBrains Mono', 'Inter', monospace;
      font-weight: 800;
      font-size: 2.5rem;
      /* Ukuran besar agar mencolok */
      letter-spacing: -1px;
      background: linear-gradient(90deg, #0d6efd, #00d2ff, #0d6efd);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 4s linear infinite;
      display: block;
      margin: 10px 0;
    }

    /* Animasi kilau pada teks timer */
    @keyframes shine {
      to {
        background-position: 200% center;
      }
    }

    /* Status Badge dengan efek Pulse (Berdenyut) */
    .badge-status {
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 1px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .pulse-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #198754;
      box-shadow: 0 0 0 rgba(25, 135, 84, 0.4);
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0% {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
      }
    }

    /* Merapikan Alert */
    .alert-info-custom {
      background-color: rgba(13, 110, 253, 0.05) !important;
      border: 1px solid rgba(13, 110, 253, 0.2) !important;
      border-radius: 15px;
      padding: 20px;
    }

  /* Animasi halus pada tombol */
  #btnStartVoting:hover {
    transform: translateY(-0.5px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
  }

  /* Titik hijau berkedip kecil */
  .pulse-dot-small {
    height: 6px;
    width: 6px;
    background-color: #198754;
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
    animation: pulse-green 2s infinite;
  }

  @keyframes pulse-green {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
  }

  /* Styling khusus link agar terlihat seperti tombol resmi */
  #etherscanLink {
    transition: all 0.3s ease;
    border-width: 2px;
  }
  
  #etherscanLink:hover {
    background-color: #000;
    color: #fff;
    transform: scale(1.02);
  }

  .fw-black { font-weight: 900; }
  
  /* Container Ikon Kecil */
  .icon-square-sm {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
  }

  /* Custom List untuk Misi */
  .custom-misi-list li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-main);
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .custom-misi-list li::before {
    content: "→";
    position: absolute;
    left: 0;
    color: var(--bs-primary);
    font-weight: bold;
  }

  /* Tombol Tutup Custom */
  .btn-theme-secondary {
    background-color: var(--bg-box);
    color: var(--text-main);
    border: 1px solid var(--border-color);
    transition: 0.3s;
  }
  
  .btn-theme-secondary:hover {
    background-color: #e2e6ea;
  }

  [data-theme="dark"] .btn-theme-secondary:hover {
    background-color: #3d3d3d;
  }

  /* Scrollbar halus untuk modal body */
  .modal-dialog-scrollable .modal-content {
    max-height: 90vh;
  }

  .carousel-item {
    /* Padding atas-bawah tetap, padding samping dikecilkan karena panah sudah hilang */
    padding: 15px 10px; 
    transition: transform 0.6s ease-in-out !important;
  }

  .candidate-slide-card {
    background-color: var(--bg-item);
    border: 1px solid var(--border-color);
    border-radius: 1.25rem;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 240px;
    max-width: 280px; /* Ukuran ini tetap agar tidak terlalu raksasa */
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    cursor: grab; /* Memberi petunjuk visual bahwa ini bisa digeser */
  }

  /* Mengatur tombol agar tidak terlalu lebar */
  .btn-view-profile {
    font-size: 0.75rem !important;
    padding: 8px 20px !important;
    max-width: 180px; /* Batasi lebar maksimal tombol */
    margin: 0 auto;   /* Pastikan tetap di tengah */
    border-width: 1.5px !important;
    white-space: nowrap;
    display: block;   /* Pastikan margin auto berfungsi */
  }

  /* Tambahan: Pastikan pembungkus tombol tidak memaksa stretch */
  .button-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
    margin-top: auto; /* Dorong tombol ke bawah kartu */
  }
  
  .candidate-slide-card:active {
    cursor: grabbing;
  }

  /* Warna titik saat tidak aktif */
  .carousel-indicators [data-bs-target] {
    background-color: #6c757d; /* Abu-abu */
    opacity: 0.5;
    transition: all 0.3s ease;
  }

  /* Warna titik saat aktif (sedang dilihat) */
  .carousel-indicators .active {
    background-color: var(--bs-primary) !important; /* Mengikuti warna tema (biru) */
    opacity: 1;
    transform: scale(1.2); /* Sedikit lebih besar agar menonjol */
  }
  </style>
</head>

<body>

  <!-- Alert Container -->
  <div id="alertContainer" class="alert-fixed"></div>

  <!-- Halaman Utama: Verifikasi Identitas -->
  <div id="mainPage" class="container py-5">
    <div class="text-center mb-5">
      <h1 class="fw-bold text-primary">E-VOTING PILKADES</h1>
      <p class="text-muted">Pemilihan Kepala Desa Tahun 2026</p>
    </div>

    <div class="card mx-auto" style="max-width: 540px;">
      <div class="card-header text-center">
        <h4 class="mb-0">Langkah 1 : Verifikasi Identitas</h4>
      </div>
      <div class="card-body p-4">
        <p class="text-center mb-4">
          Scan QR Code yang diberikan panitia<br>
          atau masukkan kode token secara manual
        </p>

        <div class="d-grid gap-3">
          <button id="btnScanQR" class="btn btn-primary btn-lg">
            <i class="bi bi-qr-code-scan me-2"></i> Scan QR Code
          </button>

          <div class="text-center my-2">— ATAU —</div>

          <div class="input-group input-group-lg">
            <input type="text" id="inputToken" class="form-control" placeholder="Masukkan kode token (UUID)"
              autocomplete="off" />
            <button id="btnVerifyToken" class="btn btn-outline-primary" type="button">Verifikasi</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Halaman Scan QR -->
  <div id="scanPage">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="text-white mb-0">Pindai Kode QR</h4>
      <button id="btnCloseScan" class="btn btn-outline-light btn-sm">
        <i class="bi bi-x-lg"></i> Tutup
      </button>
    </div>

    <div id="reader"></div>

    <div class="text-center mt-4">
      <button id="btnChooseGallery" class="btn btn-outline-light btn-lg">
        <i class="bi bi-images me-2"></i> Pilih dari Galeri
      </button>
      <input type="file" id="fileInput" accept="image/*" style="display:none;" />
    </div>
  </div>

  <!-- Tahap 2: Input NIK -->
  <div id="stage2" class="container py-5" style="display:none;">
    <div class="card mx-auto" style="max-width: 540px;">
      <div class="card-header text-center">
        <h4 class="mb-0">Langkah 2 : Masukkan NIK</h4>
      </div>
      <div class="card-body p-4">
        <form id="formNIK">
          <div class="mb-4">
            <label for="nikInput" class="form-label fw-bold">Nomor Induk Kependudukan (NIK)</label>
            <input type="text" class="form-control form-control-lg text-center" id="nikInput"
              placeholder="16 digit NIK Anda" maxlength="16" inputmode="numeric" pattern="[0-9]{16}" required
              autocomplete="off" />
          </div>

          <div class="d-grid">
            <button type="submit" id="btnCheckNIK" class="btn btn-primary btn-lg">
              <i class="bi bi-shield-check me-2"></i> Verifikasi & Lanjut
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="stagePanduan" class="container py-5" style="display:none;">
    <div class="card mx-auto" style="max-width: 600px;">
      <div class="card-header text-center">
        <h4 class="mb-0">Panduan & Tata Cara Voting</h4>
      </div>
      <div class="card-body p-4">
        <div class="alert alert-info">
          <i class="bi bi-info-circle-fill me-2"></i>
          Status Voting: <strong id="votingStatusText">Mengecek status...</strong>
        </div>

        <div class="mb-4">
  <h5 class="fw-bold mb-3 text-theme-main">Daftar Kandidat Tetap</h5>
  
  <div id="candidateCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
    <div id="candidatePreviewList" class="carousel-inner">
      <div class="carousel-item active">
        <div class="text-center py-5 bg-theme-box rounded-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 small text-muted">Menyiapkan surat suara...</p>
        </div>
      </div>
    </div>
    <div class="carousel-indicators" style="position: relative; margin-top: 20px;">
    </div>
  </div>
</div>

        <h5 class="fw-bold mb-3 text-theme-main">Ketentuan & Keamanan</h5>
<div class="mb-4">
  <div class="bg-theme-item d-flex align-items-center p-3 mb-2 rounded-4 border shadow-sm" style="border-color: var(--border-color) !important;">
    <i class="bi bi-1-circle-fill text-primary fs-4 me-3"></i>
    <span class="text-theme-main">Anda hanya memiliki <strong>1 (satu) kali</strong> kesempatan memilih.</span>
  </div>

  <div class="bg-theme-item d-flex align-items-center p-3 mb-2 rounded-4 border shadow-sm" style="border-color: var(--border-color) !important;">
    <i class="bi bi-lock-fill text-danger fs-4 me-3"></i>
    <span class="text-theme-main">Pilihan bersifat <strong>permanen</strong> (tidak dapat diubah/batal).</span>
  </div>

  <div class="bg-theme-item d-flex align-items-center p-3 mb-2 rounded-4 border shadow-sm" style="border-color: var(--border-color) !important;">
    <i class="bi bi-shield-shaded text-success fs-4 me-3"></i>
    <span class="text-theme-main">Identitas (NIK) dianonimkan via <strong>Blockchain Technology</strong>.</span>
  </div>

  <div class="bg-theme-item d-flex align-items-center p-3 mb-2 rounded-4 border shadow-sm" style="border-color: var(--border-color) !important;">
    <i class="bi bi-wifi text-warning fs-4 me-3"></i>
    <span class="text-theme-main small">Pastikan koneksi internet stabil sebelum menekan kirim.</span>
  </div>
</div>

<div class="text-center mb-4 p-4 rounded-4 bg-theme-box shadow-sm" 
     style="border: 2px dashed var(--border-color) !important;">
    
    <div class="d-flex align-items-center justify-content-center mb-1">
        <small class="text-muted fw-bold text-uppercase" style="letter-spacing: 1px; font-size: 0.7rem;">
            Audit Transparansi Digital
        </small>
        <i class="bi bi-patch-check-fill text-primary ms-2" style="font-size: 0.9rem;"></i>
    </div>
    
    <p class="small text-muted mb-3">Pantau isi kotak suara secara real-time:</p>
    
    <a id="etherscanLink" href="#" target="_blank" 
       class="btn btn-outline-primary btn-sm rounded-pill px-4 fw-bold shadow-sm mb-3">
        <i class="bi bi-box-seam me-2"></i> Buka Kotak Suara Digital
    </a>

    <div>
        <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2 rounded-pill" style="font-size: 0.65rem;">
            <span class="pulse-dot-small"></span> Terhubung ke Jaringan Blockchain
        </span>
    </div>
</div>

<div class="d-grid">
  <button id="btnStartVoting" class="btn btn-primary btn-lg shadow-sm">
    Mulai Voting Sekarang <i class="bi bi-arrow-right ms-2"></i>
  </button>
</div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="stageLoading" class="container py-5 text-center" style="display:none;">
    <div class="loader"></div>
    <h4 class="mt-4">Sedang memproses...</h4>
    <p class="text-muted">Mohon tunggu sebentar</p>
  </div>

  <div id="theme-touch" class="assistive-touch">
    <i class="bi bi-sun-fill" id="theme-icon"></i>
  </div>

  <div class="modal fade" id="candidateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-2xl bg-theme-card" style="border-radius: 30px; overflow: hidden;">
      
      <div id="modalHeaderColor" class="position-relative" style="height: 140px; transition: 0.5s ease;">
        <div class="position-absolute w-100 h-100" style="background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0));"></div>
      </div>

      <div class="modal-body pt-0 px-4 text-center" style="margin-top: -60px;">
        <div class="position-relative d-inline-block">
          <img id="modalFoto" src="" class="rounded-circle border border-5 shadow-lg mb-3"
            style="width: 120px; height: 120px; object-fit: cover; background: white; border-color: var(--bg-card) !important;">
          <span id="modalNoUrut" class="position-absolute bottom-0 end-0 badge rounded-pill shadow-sm py-2 px-3 fw-bold" 
                style="font-size: 0.8rem; transform: translate(10%, -20%); border: 3px solid var(--bg-card);"></span>
        </div>

        <div class="mt-2 mb-4">
          <h3 id="modalNamaKetua" class="fw-black mb-0 text-theme-main" style="letter-spacing: -1px;"></h3>
          <div class="d-inline-block px-3 py-1 rounded-pill bg-primary bg-opacity-10 text-primary small fw-bold" id="modalTaglineDisplay">
             <i class="bi bi-quote me-1"></i><span id="modalTagline"></span>
          </div>
        </div>

        <div class="text-start mb-4">
          <div class="d-flex align-items-center mb-2">
            <div class="icon-square-sm bg-primary text-white me-2"><i class="bi bi-eye-fill"></i></div>
            <label class="fw-bold small text-uppercase text-muted" style="letter-spacing: 1px;">Visi Utama</label>
          </div>
          <div class="p-3 rounded-4 bg-theme-box border-0" id="visiContainer">
            <p id="modalVisi" class="mb-0 text-theme-main" style="line-height: 1.6; font-size: 0.95rem;"></p>
          </div>
        </div>

        <div class="text-start mb-2">
          <div class="d-flex align-items-center mb-2">
            <div class="icon-square-sm bg-success text-white me-2"><i class="bi bi-list-check"></i></div>
            <label class="fw-bold small text-uppercase text-muted" style="letter-spacing: 1px;">Misi & Program Kerja</label>
          </div>
          <div class="p-1 rounded-4 bg-theme-box" id="misiContainer">
            <ul id="modalMisi" class="list-unstyled mb-0 p-3 custom-misi-list"></ul>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 p-4 pt-0">
        <button type="button" class="btn btn-theme-secondary w-100 rounded-4 py-3 fw-bold shadow-sm" data-bs-dismiss="modal">Tutup Profil</button>
      </div>
    </div>
  </div>
</div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // === KONFIGURASI ===
    const BACKEND_URL = 'https://15ed-103-129-24-34.ngrok-free.app';
    const NGROK_HEADERS = {
      "ngrok-skip-browser-warning": "69420"
    };

    function getFullImageUrl(path) {
      if (!path) return 'img/default.png';
      if (path.startsWith('http')) return path;
      const fileName = path.split('/').pop();
      return `/img/${fileName}`;
    }

    let countdownInterval = null;
    let currentToken = null;
    let currentNIK = null;
    let html5QrCode = null;

    // === HELPER ===
    function showStage(stageId) {
      document.querySelectorAll('[id^="stage"], #mainPage, #scanPage').forEach(el => el.style.display = 'none');
      document.getElementById(stageId).style.display = 'block';

      // LOGIKA BARU: Sembunyikan Assistive Touch saat scan
      const touchBtn = document.getElementById('theme-touch');
      if (stageId === 'scanPage') {
        touchBtn.style.setProperty('display', 'none', 'important');
      } else {
        // Tampilkan kembali sebagai flex (sesuai CSS awal)
        touchBtn.style.setProperty('display', 'flex', 'important');
      }
    }

    function showAlert(message, type = 'danger') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      document.getElementById('alertContainer').appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    // === SCAN QR FULL SCREEN ===
    async function openScanMode() {
      showStage('scanPage');

      // Pastikan reader bersih sebelum mulai
      document.getElementById('reader').innerHTML = '';

      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          html5QrCode = null;
        } catch (e) { html5QrCode = null; }
      }

      html5QrCode = new Html5Qrcode("reader");

      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 300, height: 300 } },
        (decodedText) => {
          html5QrCode.stop().then(() => {
            html5QrCode = null;
            // Mengambil token saja jika yang di-scan adalah URL
            const rawText = decodedText.trim();
            const tokenOnly = rawText.includes('token=') ? rawText.split('token=')[1].split('&')[0] : rawText;

            processToken(tokenOnly);
          });
        },
        (err) => { /* scanning... */ }
      ).catch((err) => {
        console.warn("Kamera ditolak/error:", err);
        // PENTING: Jika ditolak, hancurkan objek agar tidak mengunci fitur Galeri
        if (html5QrCode) {
          html5QrCode.clear();
          html5QrCode = null;
        }
        showAlert('Akses kamera ditolak. Kamu tetap bisa menggunakan fitur "Pilih dari Galeri".', 'warning');
      });
    }

    function closeScanMode() {
      if (html5QrCode) {
        html5QrCode.stop();
        html5QrCode = null;
      }
      showStage('mainPage');
    }

    // === PROSES TOKEN ===
    async function processToken(token) {
      if (!token) return;

      closeScanMode();
      showStage('stageLoading');

      try {
        const res = await fetch(`${BACKEND_URL}/verify-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...NGROK_HEADERS },
          body: JSON.stringify({ token })
        });

        const data = await res.json();

        if (!data.success) throw new Error(data.error || 'Token tidak valid');

        currentToken = token;
        showStage('stage2');
        document.getElementById('nikInput').focus();

      } catch (err) {
        showAlert(err.message || 'Gagal memverifikasi token');
        showStage('mainPage');
      }
    }

    // === EVENT LISTENER ===
    document.getElementById('btnScanQR').addEventListener('click', openScanMode);
    document.getElementById('btnCloseScan').addEventListener('click', closeScanMode);

    document.getElementById('btnChooseGallery').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      showStage('stageLoading');

      // Gunakan instance BARU dan BERBEDA khusus untuk file
      // Ini rahasianya agar tidak bentrok dengan sisa-sisa error kamera
      const fileScanner = new Html5Qrcode("reader");

      try {
        const decodedText = await fileScanner.scanFile(file, true);
        await fileScanner.clear();
        const rawText = decodedText.trim();
        // Logika: Jika ada kata 'token=', ambil teks setelahnya. Jika tidak, ambil teks asli.
        const tokenOnly = rawText.includes('token=') ? rawText.split('token=')[1].split('&')[0] : rawText;

        processToken(tokenOnly);
      } catch (err) {
        console.error("Gagal baca file:", err);
        if (fileScanner) await fileScanner.clear();

        showAlert('Gagal membaca QR: Pastikan gambar tajam, tidak buram, dan QR Code terlihat jelas.', 'danger');
        showStage('mainPage');
      } finally {
        e.target.value = ''; // Reset input agar bisa pilih file yang sama lagi
      }
    });
    // Verifikasi manual
    document.getElementById('btnVerifyToken').addEventListener('click', () => {
      const token = document.getElementById('inputToken').value.trim();
      if (token) processToken(token);
      else showAlert('Masukkan kode token terlebih dahulu!');
    });

    // Fungsi untuk mengecek status voting dari contract melalui backend
    async function checkVotingStatus() {
      try {
        const res = await fetch(`${BACKEND_URL}/voting-status`, {
          headers: NGROK_HEADERS // Tambahkan ini
        });
        const data = await res.json();

        // Cari atau buat container timer di dalam alert
        let timerDisplay = document.getElementById('countdownTimer');
        let badgeContainer = document.getElementById('statusBadgeContainer');

        if (!timerDisplay) {
          const alertBox = document.querySelector('#stagePanduan .alert-info');
          alertBox.classList.add('alert-info-custom', 'text-center');
          alertBox.innerHTML = `
                <div class="mb-2 small text-uppercase fw-bold text-muted">Status Pemilihan</div>
                <div id="statusBadgeContainer"></div>
                <div id="countdownTimer">00:00:00</div>
                <div id="timerLabel" class="small text-muted">Waktu tersisa untuk memberikan suara</div>
            `;
          timerDisplay = document.getElementById('countdownTimer');
          badgeContainer = document.getElementById('statusBadgeContainer');
        }

        const btnStart = document.getElementById('btnStartVoting');

        // Hentikan interval sebelumnya jika ada sebelum memulai yang baru
        if (countdownInterval) clearInterval(countdownInterval);

        if (data.status === 'active') {
          badgeContainer.innerHTML = '<span class="badge-status bg-success-subtle text-success border border-success"><span class="pulse-dot"></span> BERLANGSUNG</span>';
          btnStart.disabled = false;

          // Jalankan timer
          runTimer(data.targetTime, timerDisplay, () => {
            badgeContainer.innerHTML = '<span class="badge-status bg-danger-subtle text-danger border border-danger">WAKTU HABIS</span>';
            btnStart.disabled = true;
            timerDisplay.innerText = "00:00:00";
            document.getElementById('timerLabel').innerText = "Sesi telah berakhir secara otomatis.";
          });

        } else if (data.status === 'upcoming') {
          badgeContainer.innerHTML = '<span class="badge-status bg-warning-subtle text-warning border border-warning">BELUM DIMULAI</span>';
          btnStart.disabled = false;
          timerDisplay.innerText = "--:--:--";
          document.getElementById('timerLabel').innerText = "Menunggu pembukaan oleh panitia.";

        } else {
          badgeContainer.innerHTML = '<span class="badge-status bg-secondary-subtle text-secondary border border-secondary">VOTING SELESAI</span>';
          btnStart.disabled = false;
          timerDisplay.innerText = "CLOSED";
          document.getElementById('timerLabel').innerText = "Penerimaan suara telah ditutup.";
        }
      } catch (err) {
        console.error("Gagal cek status:", err);
      }
    }

    function runTimer(targetTime, displayElement, onFinish) {
      function update() {
        const now = new Date().getTime();
        const diff = targetTime - now;

        if (diff <= 0) {
          clearInterval(countdownInterval);
          displayElement.innerText = "00:00:00";
          if (onFinish) onFinish();
          return;
        }

        const h = Math.floor(diff / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);

        displayElement.innerText =
          `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }

      update(); // Jalankan sekali langsung tanpa nunggu 1 detik
      countdownInterval = setInterval(update, 1000);
    }

    // === INPUT NIK + VALIDASI NIK HASH ===
    document.getElementById('formNIK').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nik = document.getElementById('nikInput').value.trim();

      if (!/^\d{16}$/.test(nik)) {
        showAlert('NIK harus tepat 16 digit angka!');
        return;
      }

      currentNIK = nik;
      showStage('stageLoading');

      try {
        const res = await fetch(`${BACKEND_URL}/verify-nik`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...NGROK_HEADERS },
          body: JSON.stringify({ nik: nik })
        });

        const data = await res.json();
        if (!data.success) throw new Error(data.error);

        // BERHASIL: Munculkan Panduan terlebih dahulu
        showStage('stagePanduan');
        checkVotingStatus();
        loadCandidatePreview();
        updateContractLink();

      } catch (err) {
        showAlert(err.message);
        showStage('stage2');
      }
    });

    // === BARU: Navigasi ke user.html ===
    document.getElementById('btnStartVoting').addEventListener('click', () => {
      // Simpan NIK dan Token di SessionStorage agar bisa dibaca di user.html
      sessionStorage.setItem('voterNIK', currentNIK);
      sessionStorage.setItem('voterToken', currentToken);

      // Arahkan ke halaman user.html
      window.location.href = 'user/user.html';
    });

    let allCandidatesData = [];

    // 1. Ambil data gabungan dari Backend
    async function loadCandidatePreview() {
      try {
        const res = await fetch(`${BACKEND_URL}/results`, {
          headers: NGROK_HEADERS // Tambahkan ini
        });
        allCandidatesData = await res.json();

        const previewList = document.getElementById('candidatePreviewList');
  const indicators = document.querySelector('.carousel-indicators');
  previewList.innerHTML = '';
  if(indicators) indicators.innerHTML = ''; // Reset titik

  allCandidatesData.forEach((cand, index) => {
    const isActive = index === 0 ? 'active' : '';
    
    // Tambah Titik Indikator
    if(indicators) {
      indicators.innerHTML += `
        <button type="button" data-bs-target="#candidateCarousel" data-bs-slide-to="${index}" 
                class="${isActive}" aria-current="${isActive ? 'true' : 'false'}" 
                style="width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-muted); border: none; margin: 0 4px;">
        </button>`;
    }
    
    previewList.innerHTML += `
      <div class="carousel-item ${isActive}">
        <div class="candidate-slide-card shadow-sm" onclick="showCandidateDetail(${index})">
          
          <div class="position-relative mb-3 text-center">
            <img src="${getFullImageUrl(cand.foto)}" 
                 class="rounded-circle border border-2 shadow-sm" 
                 style="width: 85px; height: 85px; object-fit: cover; border-color: ${cand.warna} !important; background: white;">
            <span class="position-absolute top-0 start-50 translate-middle-x badge rounded-pill shadow-sm" 
                  style="background-color: ${cand.warna}; font-size: 0.7rem; margin-top: -8px; border: 2px solid white; padding: 4px 10px;">
                  No. ${cand.noUrut}
            </span>
          </div>

          <div class="candidate-name-slide">${cand.nama}</div>
          <p class="text-muted mb-3 text-center" style="font-size: 0.7rem;"></p>
          
          <button class="btn btn-outline-primary btn-view-profile rounded-pill fw-bold">
            Lihat Visi-Misi
          </button>
        </div>
      </div>
    `;
  });

  // PAKSA CAROUSEL JALAN OTOMATIS SETELAH DATA LOAD
  const myCarousel = document.querySelector('#candidateCarousel');
  const carousel = new bootstrap.Carousel(myCarousel, {
    interval: 3000, // Kecepatan (3 detik)
    ride: 'carousel',
    pause: 'hover' // Slide akan berhenti jika kursor mouse diletakkan di atas kartu
  });
      } catch (err) {
        console.error("Gagal load preview:", err);
      }
    }

    // 2. Tampilkan Detail ke Modal
    function showCandidateDetail(index) {
  const cand = allCandidatesData[index];
  const modal = new bootstrap.Modal(document.getElementById('candidateModal'));

  // Update Visual Colors
  document.getElementById('modalHeaderColor').style.background = 
    `linear-gradient(135deg, ${cand.warna} 0%, ${cand.warna}dd 100%)`;
  document.getElementById('modalNoUrut').style.backgroundColor = cand.warna;
  document.getElementById('modalNoUrut').classList.add('text-white');

  // Update Text Data
  document.getElementById('modalFoto').src = getFullImageUrl(cand.foto);
  document.getElementById('modalNoUrut').innerText = `No. Urut ${cand.noUrut}`;
  document.getElementById('modalNamaKetua').innerText = cand.nama;

  document.getElementById('modalTagline').innerText = cand.tagline;
  document.getElementById('modalVisi').innerText = cand.visi;

  // Render Misi dengan gaya List Baru
  const misiList = document.getElementById('modalMisi');
  misiList.innerHTML = '';
  if (Array.isArray(cand.misi)) {
    cand.misi.forEach(m => {
      misiList.innerHTML += `<li>${m}</li>`;
    });
  }

  modal.show();
}

    // === Inisialisasi ===
    showStage('mainPage');

    const touchBtn = document.getElementById('theme-touch');
    const themeIcon = document.getElementById('theme-icon');

    let isDragging = false;
    let startX, startY, initialX, initialY;

    // --- LOGIKA THEME ---
    // Fungsi untuk update ikon saja (tanpa animasi)
    function updateIconOnly(theme) {
      if (theme === 'dark') {
        themeIcon.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
      } else {
        themeIcon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
      }
    }

    // Fungsi untuk apply tema dengan animasi (untuk Klik Manual)
    function applyTheme(theme, animate = true) {
      if (!animate) {
        document.documentElement.setAttribute('data-theme', theme);
        updateIconOnly(theme);
        return;
      }

      // Animasi keluar
      themeIcon.style.transform = "rotate(180deg) scale(0)";
      themeIcon.style.opacity = "0";

      setTimeout(() => {
        document.documentElement.setAttribute('data-theme', theme);
        updateIconOnly(theme);

        // Animasi masuk
        themeIcon.style.transform = "rotate(0deg) scale(1)";
        themeIcon.style.opacity = "1";

        localStorage.setItem('theme-preference', theme);
      }, 200);
    }

    // --- FITUR REAL-TIME SYSTEM SYNC ---
    const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

    function handleSystemThemeChange(e) {
      // Hanya ganti otomatis jika user belum pernah mengatur secara manual
      if (!localStorage.getItem('theme-preference')) {
        const newTheme = e.matches ? 'dark' : 'light';
        applyTheme(newTheme, false); // false = tanpa animasi transisi ikon agar tidak mengganggu
      }
    }

    // Pasang listener untuk perubahan sistem (Real-time)
    darkModeMediaQuery.addEventListener('change', handleSystemThemeChange);

    // --- INISIALISASI AWAL ---
    function initTheme() {
      const savedTheme = localStorage.getItem('theme-preference');
      const systemTheme = darkModeMediaQuery.matches ? 'dark' : 'light';
      const finalTheme = savedTheme || systemTheme;

      // Terapkan instan tanpa animasi agar tidak splash
      applyTheme(finalTheme, false);

      // Berikan sedikit jeda lalu aktifkan transisi CSS agar klik selanjutnya smooth
      setTimeout(() => {
        document.documentElement.classList.add('loaded');
      }, 100);
    }

    // Jalankan init
    initTheme();

    // --- LOGIKA DRAG (Mobile & Desktop) ---
    touchBtn.addEventListener('pointerdown', (e) => {
      isDragging = false;
      startX = e.clientX;
      startY = e.clientY;

      const rect = touchBtn.getBoundingClientRect();
      initialX = rect.left;
      initialY = rect.top;

      touchBtn.setPointerCapture(e.pointerId);
    });

    touchBtn.addEventListener('pointermove', (e) => {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
        isDragging = true;

        // Hitung posisi baru
        let newX = initialX + dx;
        let newY = initialY + dy;

        // Batas-batas layar (clamping)
        const padding = 15; // Jarak aman dari pinggir
        const maxX = window.innerWidth - touchBtn.offsetWidth - padding;
        const maxY = window.innerHeight - touchBtn.offsetHeight - padding;

        // Terapkan pembatasan agar tidak keluar frame
        newX = Math.max(padding, Math.min(newX, maxX));
        newY = Math.max(padding, Math.min(newY, maxY));

        touchBtn.style.left = `${newX}px`;
        touchBtn.style.top = `${newY}px`;
        touchBtn.style.bottom = 'auto';
        touchBtn.style.right = 'auto';
      }
    });

    touchBtn.addEventListener('pointerup', (e) => {
      if (!isDragging) {
        // Jika hanya diklik (bukan digeser), ganti tema
        const currentTheme = document.documentElement.getAttribute('data-theme');
        applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
      }

      // Opsional: Magnetik (tombol akan nempel ke sisi terdekat)
      const windowWidth = window.innerWidth;
      const rect = touchBtn.getBoundingClientRect();
      if (rect.left + rect.width / 2 < windowWidth / 2) {
        touchBtn.style.left = '15px';
      } else {
        touchBtn.style.left = (windowWidth - rect.width - 15) + 'px';
      }
    });

    // Cek saat halaman pertama kali dibuka
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const tokenDariUrl = urlParams.get('token');

      if (tokenDariUrl) {
        console.log("Token terdeteksi dari URL:", tokenDariUrl);
        // Langsung jalankan fungsi verifikasi kamu
        processToken(tokenDariUrl);
      }
    });

    async function updateContractLink() {
  try {
    const res = await fetch(`${BACKEND_URL}/contract-info`, {
      headers: NGROK_HEADERS
    });
    const data = await res.json();
    
    const linkEl = document.getElementById('etherscanLink');
    if (data.address && linkEl) {
      linkEl.href = data.explorerUrl;
      // Tetap gunakan istilah Kotak Suara Digital
      linkEl.innerHTML = `<i class="bi bi-box-seam me-2"></i> Buka Kotak Suara Digital`;
    }
  } catch (err) {
    console.error("Gagal memuat link:", err);
    document.getElementById('etherscanLink').innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i> Kotak Suara Sedang Maintenance`;
  }
}
  </script>
</body>

</html>